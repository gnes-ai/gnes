# BASIC STAGES

stage-install-dep: &stage_install_deps
  - name: install dependencies
    jobs:
      - name: setup ci environment
        script:
          - mkdir -p .cache && ln -snf $(pwd)/.cache $HOME/.cache
          - export PIP_DOWNLOAD_CACHE=${pwd}/.cache/pip_download_cache && export XDG_CACHE_HOME=${pwd}/.cache/pip
          - printf "XDG_CACHE_HOME=$XDG_CACHE_HOME\nPIP_DOWNLOAD_CACHE=$PIP_DOWNLOAD_CACHE\n"
          - cat /proc/cpuinfo | grep flags
          - "python -c 'import tensorflow as tf; print(tf.__version__); a=tf.constant(1, tf.int32); print(tf.Session().run(a))'"
          - nvcc --version
      - name: install project deps
        env:
          INDEX_URL: https://mirrors.tencent.com/pypi/simple/
          TRUST_DOM: mirrors.tencent.com
        script:
          - "pip install cffi==1.12.3 coverage codecov -i ${INDEX_URL} --extra-index-url ${INDEX_URL} --trusted-host ${TRUST_DOM}"
          - "pip install -e .[all] -i ${INDEX_URL} --extra-index-url ${INDEX_URL} --trusted-host ${TRUST_DOM}"
          - pip uninstall -y torchvision
          - pip install https://download.pytorch.org/whl/cu100/torchvision-0.3.0-cp36-cp36m-linux_x86_64.whl
          - "python -c 'import torchvision; print(torchvision.__version__)'"
          - "python -c 'import torch; print(torch.__version__)'"

stage-pylint: &stage_pylint
  - name: check code style
    script: pylint gnes/**/*.py --exit-zero

stage-unit-test: &stage_unit_test
  - name: run unit test
    script: python -m unittest tests/*.py -v

stage-notify-done: &stage_notify
  - name: notify the success
    jobs:
      job1:
        - name: make comment
          script: echo "ğŸŠ looks good to me ğŸ‘" > comment.txt
        - name: submit comment
          type: git:comment
          options:
            fromFile: comment.txt
      job2:
        - name: make notification
          script: echo "$SUCCESS_MSG" > notify.md
        - name: message
          type: wework:message
          options:
            robot: $BOT_ID
            fromFile: notify.md

stage-notify-all: &stage_notify_all
  - name: notfiy the success to all
    jobs:
      - name: make notification
        script: echo "# ğŸŠğŸš€ GNESçš„Masteråˆ†æ”¯åˆšåˆšæ›´æ–°äº†ï¼\næ­¤æ¬¡æ›´æ–°ç”±$ORANGE_BUILD_USERæäº¤çš„$ORANGE_MERGE_REQUEST_BRANCHåˆå¹¶åè§¦å‘ï¼Œ[ç‚¹å‡»æŸ¥çœ‹]($ORANGE_EVENT_URL)" > notify.md
      - name: send mail
        type: mail:send
        options:
          title: ğŸŠğŸš€ GNESçš„Masteråˆ†æ”¯åˆšåˆšæ›´æ–°ï¼
          to:
            - hanhxiao
            - larryjfyan
            - madwang
            - leonjiang
            - raccoonliu
            - kegokang
          type: markdown
          fromFile: notify.md
      - name: message
        type: wework:message
        options:
          robot: $BOT_ID
          fromFile: notify.md

stage-commit-lint: &stage_commit_lint
  - name: do commit lint
    script:
      - npm install --global --save-dev @commitlint/config-conventional @commitlint/cli --registry=http://r.tnpm.oa.com
      - "echo \"module.exports = {extends: ['@commitlint/config-conventional']}\" > commitlint.config.js"
      - echo $ORANGE_LATEST_COMMIT_MESSAGE | commitlint

stage-coverity: &stage_coverity
  - name: do coverity
    script:
      - coverage run -m unittest discover -s tests/
      - coverage report --skip-covered
      - codecov --token $CODECOV_TOKEN

# lint

pipe-lint: &pipe_lint
  docker:
    image: node:alpine
  network: idc-hk
  wework:
    title: "ğŸŠâŒ›ğŸ–Šï¸ Check commit lint"
  stages:
    - <<: *stage_commit_lint

pipe-unit-test: &pipe_unit_test
  network: idc-ai-sse4
  wework:
    title: "ğŸŠâŒ›ğŸ— Install GNES and do unit test"
  docker:
    image: ccr.ccs.tencentyun.com/gnes/ci-base
  env:
    GNES_ENV_SET: orange-ci
    PIP_DOWNLOAD_CACHE: ${pwd}/.cache/pip_download_cache
    XDG_CACHE_HOME: ${pwd}/.cache/pip
    SUCCESS_MSG: "# ğŸŠâœ…ğŸ˜ƒ All tests passed, good job! \nç”±$ORANGE_BUILD_USERæäº¤çš„$ORANGE_MERGE_REQUEST_BRANCHåˆ†æ”¯åˆšåˆšæµ‹è¯•é€šè¿‡ï¼\n[ç‚¹å‡»æŸ¥çœ‹]($ORANGE_EVENT_URL)"
  cacheFrom: .orange-ci.cache
  stages:
    - <<: *stage_install_deps
    - <<: *stage_unit_test
    - <<: *stage_notify

pipe-coverity: &pipe_coverity
  network: idc-ai-sse4
  wework:
    title: "ğŸŠâŒ›ğŸ— Do coverity check on the new master"
  docker:
    image: ccr.ccs.tencentyun.com/gnes/ci-base
  env:
    GNES_ENV_SET: orange-ci
    PIP_DOWNLOAD_CACHE: ${pwd}/.cache/pip_download_cache
    XDG_CACHE_HOME: ${pwd}/.cache/pip
    SUCCESS_MSG: "# ğŸŠâœ…ğŸ˜ƒ Report is successfully updated!"
  envFrom: https://git.code.oa.com/gnes/secret-keys/blob/master/keys
  cacheFrom: .orange-ci.cache
  stages:
    - <<: *stage_install_deps
    - <<: *stage_coverity
    - <<: *stage_notify
    - <<: *stage_notify_all


docker-stage: &docker_stage
  - name: docker push
    jobs:
      - name: docker login
        script: docker login -u $DOCKER_USER -p $DOCKER_PWD docker.oa.com:8080
      - name: push docker
        script: export DOCKER_NAMESPACE="docker.oa.com:8080/public" && bash docker-push.sh $GIT_TAG
      - name: make notification
        script: export DOCKER_NAMESPACE="docker.oa.com:8080/public" && echo "# ğŸ—³ï¸ NESå®¹å™¨çš„$GIT_TAGç‰ˆæœ¬åˆšåˆšæ›´æ–°è‡³$DOCKER_NAMESPACEï¼\nè¿è¡Œæ­¤ç‰ˆæœ¬ï¼š\ndocker pull $DOCKER_NAMESPACE/$PROJ_NAME:$GIT_TAG && docker run -v /data1/cips/data:/ext_data -it $DOCKER_NAMESPACE/$PROJ_NAME:$GIT_TAG bash" >>notify.md
      - name: docker login
        script: docker login -u $TCLOUD_USER -p $TCLOUD_PWD ccr.ccs.tencentyun.com
      - name: push docker
        script: export DOCKER_NAMESPACE="ccr.ccs.tencentyun.com/gnes" && bash docker-push.sh $GIT_TAG
      - name: make notification
        script: export DOCKER_NAMESPACE="ccr.ccs.tencentyun.com/gnes" && echo "# ğŸ—³ï¸ NESå®¹å™¨çš„$GIT_TAGç‰ˆæœ¬åˆšåˆšæ›´æ–°è‡³$DOCKER_NAMESPACEï¼\nè¿è¡Œæ­¤ç‰ˆæœ¬ï¼š\ndocker pull $DOCKER_NAMESPACE/$PROJ_NAME:$GIT_TAG && docker run -v /data1/cips/data:/ext_data -it $DOCKER_NAMESPACE/$PROJ_NAME:$GIT_TAG bash" >> notify.md

release-stage: &release_stage1
  - name: notify about release
    jobs:
      - name: send mail
        type: mail:send
        options:
          title: ğŸ—³ï¸ NESå®¹å™¨çš„$GIT_TAGåˆšåˆšæ›´æ–°ï¼
          to:
            - hanhxiao
            - larryjfyan
            - madwang
          type: markdown
          fromFile: notify.md
      - name: message
        type: wework:message
        options:
          robot: $BOT_ID
          fromFile: notify.md

release-stage2: &release_stage2
  - name: notify about release
    jobs:
      - name: send mail
        type: mail:send
        options:
          title: ğŸ—³ï¸ NESå®¹å™¨çš„$GIT_TAGåˆšåˆšæ›´æ–°ï¼
          to:
            - g_AIPD_SC_RELEVANCE
          type: markdown
          fromFile: notify.md
      - name: message
        type: wework:message
        options:
          robot: $BOT_ID
          fromFile: notify.md

docker-pipeline1: &dp1
  network: devnet
  services:
    - docker
  envFrom: https://git.code.oa.com/gnes/secret-keys/blob/master/keys
  env:
    PROJ_NAME: aipd-gnes
    GIT_TAG: master
  stages:
    - <<: *docker_stage
    - <<: *release_stage1

docker-pipeline2: &dp2
  network: devnet
  services:
    - docker
  envFrom: https://git.code.oa.com/gnes/secret-keys/blob/master/keys
  env:
    PROJ_NAME: aipd-gnes
    GIT_TAG: $ORANGE_BRANCH
  stages:
    - <<: *docker_stage
    - <<: *release_stage2

master:
  merge_request:
    - <<: *pipe_lint
    - <<: *pipe_unit_test
  push:
    - <<: *pipe_coverity

"**":
  tag_push:
    - <<: *dp2